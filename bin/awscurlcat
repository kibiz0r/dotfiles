#!/usr/bin/env zsh

stderrfile=$( mktemp )
stdout=$( awscurl --verbose $@ 2> $stderrfile )
exitcode=$?
stderr=$( cat $stderrfile )

response=$( echo $stdout | gtail -n +3 )

if [[ $exitcode == 0 ]]; then
  statuscode=$( echo $stderr | gtail -2 | ghead -1 | egrep -o '\d+' | ghead -1 )

  if [[ ! -f $HOME/.httpcat$statuscode ]]; then
    curl -so $HOME/.httpcat$statuscode https://http.cat/$statuscode
  fi

  imgcat $HOME/.httpcat$statuscode 1>&2
fi

echo $response

exit $exitcode
